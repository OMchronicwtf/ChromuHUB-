local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer

local Remotes = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Gameplay")
local PlayerDataChanged = Remotes:WaitForChild("PlayerDataChanged")
local LoadingMapEvent = Remotes:WaitForChild("LoadingMap")

local Roles = {}
local CurrentMapName = nil
local CurrentGameMode = nil
local MatchActive = false

local function UpdateMapName()
    for _, obj in Workspace:GetChildren() do
        if (obj:IsA("Model") or obj:IsA("Folder")) and obj:GetAttribute("MapID") then
            CurrentMapName = obj.Name
            return
        end
    end
    CurrentMapName = nil
end

LoadingMapEvent.OnClientEvent:Connect(function(mode)
    if typeof(mode) == "string" then
        CurrentGameMode = mode
    end
end)

PlayerDataChanged.OnClientEvent:Connect(function(update)
    if typeof(update) ~= "table" then return end

    if not next(update) then
        MatchActive = false
        Roles = {}
        return
    end

    if not MatchActive then
        MatchActive = true
        UpdateMapName()
    end

    for name, data in pairs(update) do
        if typeof(data) == "table" then
            Roles[name] = data
        end
    end
end)

Workspace.ChildAdded:Connect(function(child)
    if child:GetAttribute("MapID") then
        UpdateMapName()

        task.spawn(function()
            local remote = ReplicatedStorage:FindFirstChild("GetPlayerData", true)
            if not remote then return end

            for _ = 1, 20 do
                local s, d = pcall(remote.InvokeServer, remote)
                if s and typeof(d) == "table" and next(d) then
                    Roles = d
                    MatchActive = true
                    break
                end
                task.wait(0.5)
            end
        end)
    end
end)

Workspace.ChildRemoved:Connect(function(child)
    if child:GetAttribute("MapID") then
        MatchActive = false
        Roles = {}
        CurrentMapName = nil
    end
end)

task.spawn(function()
    UpdateMapName()

    if CurrentMapName then
        local remote = ReplicatedStorage:FindFirstChild("GetPlayerData", true)
        if remote and remote:IsA("RemoteFunction") then
            local s, d = pcall(remote.InvokeServer, remote)
            if s and typeof(d) == "table" then
                if next(d) then
                    Roles = d
                    MatchActive = true
                else
                    MatchActive = false
                    Roles = {}
                end
            end
        end
    end

    local ok, gm = pcall(function()
        return LoadingMapEvent:InvokeServer()
    end)
    if ok and typeof(gm) == "string" then
        CurrentGameMode = gm
    end
end)

task.spawn(function()
    task.wait(3)
    local remote = ReplicatedStorage:FindFirstChild("GetPlayerData", true)
    if remote then
        local s, d = pcall(remote.InvokeServer, remote)
        if s and typeof(d) == "table" and next(d) then
            Roles = d
            MatchActive = true
            UpdateMapName()
        end
    end
end)

return {

    HasMap = function()
        return CurrentMapName ~= nil
    end,

    MapName = function()
        return CurrentMapName
    end,

    GameMode = function()
        return CurrentGameMode
    end,

    MatchActive = function()
        return MatchActive
    end,

    AmInMatch = function()
        return Roles[LocalPlayer.Name] ~= nil
    end,

    MyRole = function()
        local info = Roles[LocalPlayer.Name]
        return info and info.Role or nil
    end,

    IsAlive = function()
        local info = Roles[LocalPlayer.Name]
        return info and not info.Dead or false
    end,

    IsDead = function()
        local info = Roles[LocalPlayer.Name]
        return info and info.Dead or false
    end,

    Roles = function()
        return Roles
    end,

    GetRole = function(name)
        name = name or LocalPlayer.Name
        local info = Roles[name]
        return info and info.Role or nil
    end,

    PlayerDead = function(name)
        name = name or LocalPlayer.Name
        local info = Roles[name]
        return info and info.Dead or false
    end,
}
